Tuyá»‡t vá»i ğŸ‘ Giá» mÃ¬nh tá»•ng há»£p láº¡i thÃ nh má»™t **plan hoÃ n chá»‰nh** tá»« Ä‘áº§u Ä‘áº¿n cuá»‘i (trÃªn Windows PowerShell, theo yÃªu cáº§u â€œSSH vÃ o rá»“i má»›i cÃ i DE + VNCâ€), Ä‘á»ƒ báº¡n cháº¡y má»™t láº§n lÃ  xong:

---

# ğŸš€ Káº¿ hoáº¡ch triá»ƒn khai Desktop + VNC trong Docker

## 1. Chuáº©n bá»‹

* Windows cÃ i **Docker Desktop** (Linux containers).
* CÃ³ **PowerShell** vÃ  **SSH client** (`ssh -V` Ä‘á»ƒ kiá»ƒm tra; náº¿u thiáº¿u: `Add-WindowsCapability -Online -Name OpenSSH.Client~~~~0.0.1.0`).
* CÃ i **RealVNC Viewer** (hoáº·c TightVNC Viewer) trÃªn Windows.

---

## 2. Táº¡o dá»± Ã¡n

Trong PowerShell:

```powershell
mkdir vnc-desktop; cd vnc-desktop
```

### Dockerfile (chá»‰ cÃ i SSH server, khÃ´ng cÃ i sáºµn DE/VNC)

```powershell
@'
FROM ubuntu:22.04
ENV DEBIAN_FRONTEND=noninteractive TZ=Asia/Ho_Chi_Minh

RUN apt-get update && apt-get install -y \
    openssh-server sudo locales tzdata vim curl net-tools dbus-x11 \
 && rm -rf /var/lib/apt/lists/*

RUN mkdir -p /var/run/sshd

RUN useradd -ms /bin/bash student \
 && echo "student:student" | chpasswd \
 && usermod -aG sudo student \
 && sed -i 's/#\?PasswordAuthentication .*/PasswordAuthentication yes/' /etc/ssh/sshd_config \
 && sed -i 's@session\s\+required\s\+pam_loginuid.so@session optional pam_loginuid.so@g' /etc/pam.d/sshd

EXPOSE 22
CMD ["/usr/sbin/sshd","-D"]
'@ | Set-Content -Path Dockerfile -Encoding UTF8
```

### docker-compose.yml

```powershell
@'
version: "3.8"
services:
  desktop:
    build: .
    container_name: vnc-desktop
    ports:
      - "2222:22"     # SSH
    environment:
      - TZ=Asia/Ho_Chi_Minh
    volumes:
      - desktop-home:/home/student
    restart: unless-stopped
volumes:
  desktop-home:
'@ | Set-Content -Path docker-compose.yml -Encoding UTF8
```

---

## 3. Build vÃ  cháº¡y container

```powershell
docker compose up -d --build
docker ps
Test-NetConnection 127.0.0.1 -Port 2222
```

---

## 4. SSH vÃ o container

```powershell
ssh student@127.0.0.1 -p 2222
# password: student
```

---

## 5. CÃ i DE + VNC bÃªn trong container

Trong **shell Ubuntu** (sau khi SSH):

```bash
sudo apt update
sudo apt install -y xfce4 xfce4-goodies tigervnc-standalone-server dbus-x11 xauth x11-xserver-utils xfonts-base
```

---

## 6. Táº¡o máº­t kháº©u VNC vÃ  file xstartup

```bash
mkdir -p ~/.vnc
vncpasswd   # nháº­p máº­t kháº©u (chá»‰ cáº§n 1 loáº¡i, khÃ´ng cáº§n view-only)

cat > ~/.vnc/xstartup << 'EOF'
#!/bin/sh
unset SESSION_MANAGER
unset DBUS_SESSION_BUS_ADDRESS

export XDG_RUNTIME_DIR="/run/user/$(id -u)"
mkdir -p "$XDG_RUNTIME_DIR"
chmod 700 "$XDG_RUNTIME_DIR"

[ -f "$HOME/.Xresources" ] && xrdb "$HOME/.Xresources"

exec dbus-launch --exit-with-session startxfce4
EOF

chmod 700 ~/.vnc
chmod 600 ~/.vnc/passwd
chmod +x ~/.vnc/xstartup
```

---

## 7. Äáº£m báº£o socket X11 Ä‘Ãºng quyá»n

```bash
sudo mkdir -p /tmp/.X11-unix
sudo chown root:root /tmp/.X11-unix
sudo chmod 1777 /tmp/.X11-unix
```

---

## 8. Khá»Ÿi Ä‘á»™ng VNC server

```bash
vncserver :1 -geometry 1366x768 -depth 24 -localhost yes
```

Kiá»ƒm tra:

```bash
ps -ef | grep Xtigervnc
tail -n 50 ~/.vnc/*:1.log
```

---

## 9. Táº¡o SSH tunnel tá»« Windows vÃ  káº¿t ná»‘i RealVNC

TrÃªn Windows PowerShell (cá»­a sá»• má»›i, giá»¯ má»Ÿ):

```powershell
ssh -N -L 5901:127.0.0.1:5901 -p 2222 student@127.0.0.1
```

Má»Ÿ **RealVNC Viewer** â†’ nháº­p `127.0.0.1:5901` â†’ **Continue** â†’ nháº­p máº­t kháº©u VNC (Ä‘áº·t á»Ÿ `vncpasswd`) â†’ báº¡n sáº½ tháº¥y desktop **XFCE**.

---

## 10. Dá»«ng khi xong

Trong container:

```bash
vncserver -kill :1
```

TrÃªn Windows:

```powershell
docker compose down
```

---

âœ… Vá»›i plan nÃ y, báº¡n cháº¡y **Ä‘Ãºng tá»« Ä‘áº§u**, container chá»‰ build vá»›i SSH, sau Ä‘Ã³ SSH vÃ o rá»“i má»›i cÃ i **XFCE + VNC**, config `xstartup` chuáº©n â†’ káº¿t ná»‘i thÃ nh cÃ´ng qua RealVNC.

---

Báº¡n cÃ³ muá»‘n mÃ¬nh viáº¿t thÃªm **script tá»± Ä‘á»™ng start VNC (dá»n rÃ¡c + run láº¡i)** Ä‘á»ƒ báº¡n khÃ´ng pháº£i gÃµ thá»§ cÃ´ng nhiá»u lá»‡nh má»—i láº§n má»Ÿ desktop khÃ´ng?
